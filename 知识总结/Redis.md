# Redis 相关知识总结

最常使用的非关系型数据库，由于在内存中运行，速度很快，所以常作为缓存使用。

<img src="https://gitee.com/wtychn/ImageBed/raw/master/img/image-20210523203155794.png" alt="image-20210523203155794" style="zoom: 67%;" />

## 1. 数据结构

Redis 的键值对采用**哈希表**的形式存储。

## 2. 单线程模型

Redis 虽然是单线程模型，但是采用了**多路复用机制**来保证其在网络 IO 操作中能够并发处理大量客户端请求，实现高吞吐率。

<img src="https://static001.geekbang.org/resource/image/00/ea/00ff790d4f6225aaeeebba34a71d8bea.jpg" alt="img" style="zoom: 15%;" />

大体流程是这样的：

1. Linux 中的 IO 多路复用机制是指一个线程处理多个 IO 流，就是我们经常听到的 select/epoll 机制。该机制允许内核中，**同时存在多个监听套接字和已连接套接字**。图中的 FD 就是刚才所说的多个套接字。
2. select/epoll 一旦监测到 FD 上有请求到达时，就会触发相应的事件。这些事件会被放进一个**事件队列**，Redis 单线程对该事件队列不断进行处理。
3. Redis 采用 Socket 网络模型，该模型本身支持非阻塞模式。比如当 Redis 调用 accept() 但一直未有连接请求到达时，Redis 线程可以**返回处理其他操作**，而不用一直等待。

## 3. 日志与快照

Redis 的持久化主要有两大机制，即 AOF（Append Only File）日志和 RDB 快照。

### 3.1 AOF 日志

AOF 日志是写后日志，即先执行命令再把数据写入内存。

AOF 里记录的是 Redis 收到的每一条命令，这些命令是以**文本形式** (file) 保存的。" * + 数字 " 在开头，表示命令有几个部分；" $ + 数字 "表示这部分命令、键或值一共有多少字节。比如`set testkey testvalue`这条命令的日志为：

```
*3	// 表示命令有3个部分
$3	// 表示这部分有3个字节
set
$7	// 表示这部分有7个字节
testkey
$9	// 表示这部分有9个字节
testvalue
```

因为是写后日志，所以 Redis 在向 AOF 里面记录日志的时候，并不会先去对这些命令进行语法检查。

AOF 的潜在风险：

1. 如果刚执行完一个命令，还没有来得及记日志就宕机了，那么这个命令和相应的数据就有丢失的风险。

2. AOF 虽然避免了对当前命令的阻塞，但可能会给下一个操作带来阻塞风险。

相应的写会策略：

|  配置项  |     写回时机     | 数据丢失                 | 性能                             |
| :------: | :--------------: | ------------------------ | -------------------------------- |
|  Always  |     同步写会     | 可靠性高，数据基本不丢失 | 每个写命令都要落盘，性能影响较大 |
| Everysec |     每秒写回     | 宕机时丢失1秒数据        | 性能适中                         |
|    No    | 操作系统控制写回 | 宕机时丢失数据较多       | 性能好                           |

AOF 日志过大时对文件进行重写，将命令进行多合一。日志重写过程不会阻塞，由后台子进程 bgrewriteaof 来完成。过程为“一个拷贝，两处日志”：

- “一个拷贝”就是指，每次执行重写时，主线程 fork 出后台的 bgrewriteaof 子进程。此时，fork 会把主线程的内存拷贝一份给 bgrewriteaof 子进程，这里面就包含了数据库的最新数据。
- “两处日志”指的是，有新来操作时这个操作会被同时写到正在使用的日志缓冲和重写日志缓冲中。这样，重写日志也不会丢失最新的操作。

<img src="https://static001.geekbang.org/resource/image/6b/e8/6b054eb1aed0734bd81ddab9a31d0be8.jpg" alt="img" style="zoom:15%;" />

### 3.2 RDB 快照

